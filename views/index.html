<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DIS-Eksamen-Gruppe20 Booking</title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
  </head>
  <body>
    <header>
      <h1>Welcome to DIS-Eksamen-Gruppe20</h1>
      <p>
        You've discovered us <span data-visit-count>1</span> time<span data-visit-plural>s</span> - glad you're back!
      </p>
    </header>
    <main>
      <section>
        <h2>Copenhagen Gin Distillery</h2>
        <p>Join us for a night in the Danish countryside with immersive gin workshops,</p>
        <p><strong>Dates:</strong> 12 - 15 March 2026</p>
        <p><strong>Host:</strong> DIS-Eksamen-Gruppe20</p>
      </section>

      <section class="cta">
        <h3>No spots left? Join the waitlist.</h3>
        <p>
          Add yourself to the waitlist and be the first to know when a reservation opens up. We'll text you as soon as a
          spot becomes available.
        </p>
        <div class="cta__grid">
          <div class="hero" data-hero-wrapper>
            <img data-hero-image alt="Retreat preview" loading="lazy" hidden />
            <div class="notice" data-hero-fallback hidden>
              We are setting up your experience preview. Please refresh if the image does not appear.
            </div>
          </div>
          <form method="post" action="/waitlist" class="cta__form">
            <label>
              Full name
              <input type="text" name="fullName" required />
            </label>
            <label>
              Country code
              <select name="countryCode" data-country-select required>
                <option value="+45">(+45) Denmark</option>
                <option value="+1">(+1) United States</option>
                <option value="+44">(+44) United Kingdom</option>
                <option value="+33">(+33) France</option>
                <option value="+49">(+49) Germany</option>
              </select>
            </label>
            <label>
              Phone number
              <input type="tel" name="phone" inputmode="tel" pattern="[0-9\s()-]{5,}" placeholder="12 34 56 78" required />
            </label>
            <button type="submit">Join the Waitlist</button>
          </form>
        </div>
        <div class="error" data-error hidden></div>
      </section>
    </main>
    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const nameField = document.querySelector('input[name="fullName"]');
        const phoneField = document.querySelector('input[name="phone"]');
        const countrySelect = document.querySelector('[data-country-select]');
        const visitsTarget = document.querySelector('[data-visit-count]');
        const pluralTarget = document.querySelector('[data-visit-plural]');
        const errorBox = document.querySelector('[data-error]');
        const heroImage = document.querySelector('[data-hero-image]');
        const heroWrapper = document.querySelector('[data-hero-wrapper]');
        const heroFallback = document.querySelector('[data-hero-fallback]');

        if (nameField) {
          nameField.value = params.get('name') || '';
        }

        const existingCountry = params.get('phoneCountry');
        const existingLocal = params.get('phoneLocal');
        const combinedPhone = params.get('phone');

        if (countrySelect) {
          let selected = existingCountry || '+45';

          if (!existingCountry && combinedPhone && combinedPhone.startsWith('+')) {
            selected = combinedPhone.match(/^\+\d{1,4}/)?.[0] || selected;
          }

          const option = Array.from(countrySelect.options).find((opt) => opt.value === selected);
          countrySelect.value = option ? option.value : '+45';
        }

        if (phoneField) {
          let localValue = existingLocal || '';

          if (!localValue && combinedPhone) {
            localValue = combinedPhone.replace(/^\+\d{1,4}/, '');
          }

          phoneField.value = localValue;
        }

        const errorMessage = params.get('error');
        if (errorMessage && errorBox) {
          errorBox.textContent = errorMessage;
          errorBox.hidden = false;
        }

        const cookieMatch = document.cookie.match(/(?:^|; )visited=([^;]*)/);
        const visitCount = cookieMatch ? Number(decodeURIComponent(cookieMatch[1])) : 1;
        if (visitsTarget) {
          visitsTarget.textContent = String(Number.isFinite(visitCount) && visitCount > 0 ? visitCount : 1);
        }
        if (pluralTarget) {
          pluralTarget.textContent = visitCount === 1 ? '' : 's';
        }

        if (window.history && window.history.replaceState && params.toString()) {
          window.history.replaceState({}, document.title, window.location.pathname);
        }

        if (heroImage) {
          fetch('/api/cdn/hero')
            .then((response) => (response.ok ? response.json() : Promise.reject(new Error('Failed to load CDN url'))))
            .then(({ url }) => {
              if (!url) {
                throw new Error('Missing CDN url');
              }
              heroImage.src = url;
              heroImage.hidden = false;
              heroImage.addEventListener('error', () => {
                heroImage.hidden = true;
                if (heroFallback) heroFallback.hidden = false;
              });
            })
            .catch(() => {
              if (heroWrapper) heroWrapper.classList.add('hero--unavailable');
              if (heroFallback) heroFallback.hidden = false;
            });
        }
      })();
    </script>
  </body>
</html>
